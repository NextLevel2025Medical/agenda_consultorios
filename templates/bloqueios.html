{% extends "base.html" %}
{% block content %}

<div class="card max-w-4xl">

  <!-- Cabeçalho -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <h2 class="text-2xl font-semibold text-slate-100">
        Bloqueios de Agenda
      </h2>
      <p class="text-slate-400">
        Cadastre bloqueios para impedir agendamentos em dias específicos.
      </p>
    </div>

    <a
      href="/mapa"
      class="rounded-xl border border-white/10 bg-white/5 px-4 py-2 text-sm font-medium text-slate-100 hover:bg-white/10 transition"
    >
      ← Voltar para o mapa
    </a>
  </div>

  <!-- Formulário -->
  {% if edit_block %}
    <form method="post" action="/bloqueios/{{ edit_block.id }}/update" class="grid gap-4">
  {% else %}
    <form method="post" action="/bloqueios" class="grid gap-4">
  {% endif %}

    <div>
      <label class="block text-sm text-slate-300 mb-1">Data</label>
      <input
        type="date"
        name="data"
        class="input w-full"
        value="{% if edit_block %}{{ edit_block.day.isoformat() }}{% endif %}"
        required
      >
    </div>

    <div>
      <label class="block text-sm text-slate-300 mb-1">Motivo</label>
      <input
        type="text"
        name="motivo"
        class="input w-full"
        placeholder="Ex: Feriado, Viagem, Congresso"
        value="{% if edit_block %}{{ edit_block.reason }}{% endif %}"
        required
      >
    </div>

    <div>
      <label class="block text-sm text-slate-300 mb-1">Profissional</label>
      <select name="profissional" class="input w-full" required>
        <option value="todos"
          {% if edit_block and edit_block.applies_to_all %}selected{% endif %}
        >
          Todos
        </option>

        {% for s in surgeons %}
          <option value="{{ s.id }}"
            {% if edit_block and not edit_block.applies_to_all and s.id == edit_block.surgeon_id %}
              selected
            {% endif %}
          >
            {{ s.full_name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="pt-2 flex items-center gap-3">
      <button
        type="submit"
        class="w-56 rounded-xl bg-amber-500 px-4 py-3 font-semibold text-slate-950 hover:bg-amber-400 transition shadow"
      >
        {% if edit_block %}
          Salvar alterações
        {% else %}
          Salvar bloqueio
        {% endif %}
      </button>

      {% if edit_block %}
        <a
          href="/bloqueios"
          class="rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-sm font-medium text-slate-100 hover:bg-white/10 transition"
        >
          Cancelar
        </a>
      {% endif %}
    </div>

  </form>

  <!-- Lista de bloqueios -->
  <div class="mt-10">
    <h3 class="text-lg font-semibold text-slate-100 mb-3">
      Bloqueios cadastrados
    </h3>

    {% if blocks and blocks|length > 0 %}
      <div class="grid gap-3">
        {% for b in blocks %}
          <div class="rounded-xl border border-slate-700 bg-slate-900/40 px-4 py-3">
            <div class="flex items-center justify-between gap-4">

              <div>
                <div class="text-slate-100 font-semibold">
                  {{ b.day.strftime("%d/%m/%Y") }}
                </div>

                <div class="text-slate-300 text-sm">
                  {{ b.reason }} —
                  {% if b.applies_to_all %}
                    Todos os profissionais
                  {% else %}
                    {% set found = false %}
                    {% for s in surgeons %}
                      {% if s.id == b.surgeon_id %}
                        {{ s.full_name }}
                        {% set found = true %}
                      {% endif %}
                    {% endfor %}
                    {% if not found %}Profissional{% endif %}
                  {% endif %}
                </div>
              </div>

              <div class="flex items-center gap-2">
                <a
                  href="/bloqueios?edit={{ b.id }}"
                  class="rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm font-medium text-slate-100 hover:bg-white/10 transition"
                >
                  Editar
                </a>

                <form
                  method="post"
                  action="/bloqueios/{{ b.id }}/delete"
                  onsubmit="return confirm('Deseja realmente excluir este bloqueio?');"
                >
                  <button
                    type="submit"
                    class="rounded-xl border border-red-500/30 bg-red-500/10 px-3 py-2 text-sm font-semibold text-red-200 hover:bg-red-500/20 transition"
                  >
                    Excluir
                  </button>
                </form>
              </div>

            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-slate-400">
        Nenhum bloqueio cadastrado ainda.
      </p>
    {% endif %}
  </div>

</div>

{% endblock %}
