{% extends "base.html" %}
{% block content %}

<div class="card max-w-4xl">

  <!-- Cabeçalho -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <h2 class="text-2xl font-semibold text-slate-100">
        Bloqueios de Agenda
      </h2>
      <p class="text-slate-400">
        Cadastre bloqueios para impedir agendamentos em dias específicos.
      </p>
    </div>

    <a
      href="/mapa"
      class="rounded-xl border border-white/10 bg-white/5 px-4 py-2 text-sm font-medium text-slate-100 hover:bg-white/10 transition"
    >
      ← Voltar para o mapa
    </a>
  </div>

  <!-- Formulário -->
  {% if edit_block %}
    <form method="post" action="/bloqueios/{{ edit_block.id }}/update" class="grid gap-4">
  {% else %}
    <form method="post" action="/bloqueios" class="grid gap-4">
  {% endif %}

    <div>
        <label class="block text-sm text-slate-300 mb-1">Data (início)</label>
        <input type="date" name="data_inicio" value="{{ (edit_block.start_date if edit_block else '') }}" class="input w-full" required />
        <label class="block text-sm text-slate-300 mb-1 mt-4">Data (fim)</label>
        <input type="date" name="data_fim" value="{{ (edit_block.end_date if edit_block else '') }}" class="input w-full" required />
    </div>

    <div>
      <label class="block text-sm text-slate-300 mb-1">Motivo</label>
      <input
        type="text"
        name="motivo"
        class="input w-full"
        placeholder="Ex: Feriado, Viagem, Congresso"
        value="{% if edit_block %}{{ edit_block.reason }}{% endif %}"
        required
      >
    </div>

    <div>

        <label class="block text-sm text-slate-300 mb-1 mt-4">Profissionais</label>

        <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-2">
        {% for s in surgeons %}
            <label class="flex items-center gap-2 rounded-lg border border-white/10 bg-white/5 px-3 py-2">
            <input
                type="checkbox"
                name="surgeons"
                value="{{ s.id }}"
                {% if selected_surgeons and s.id in selected_surgeons %}checked{% endif %}
            />
            <span class="text-slate-100 text-sm">{{ s.full_name }}</span>
            </label>
        {% endfor %}
        </div>

        <p class="text-xs text-slate-400 mt-2">
        Se nenhum profissional for selecionado, o bloqueio será aplicado para <b>todos</b>.
        </p>

    </div>

    <div class="pt-2 flex items-center gap-3">
      <button
        type="submit"
        class="w-56 rounded-xl bg-amber-500 px-4 py-3 font-semibold text-slate-950 hover:bg-amber-400 transition shadow"
      >
        {% if edit_block %}
          Salvar alterações
        {% else %}
          Salvar bloqueio
        {% endif %}
      </button>

      {% if edit_block %}
        <a
          href="/bloqueios"
          class="rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-sm font-medium text-slate-100 hover:bg-white/10 transition"
        >
          Cancelar
        </a>
      {% endif %}
    </div>

  </form>

  <!-- Lista de bloqueios -->
  <div class="mt-10">
    <h3 class="text-lg font-semibold text-slate-100 mb-3">
      Bloqueios cadastrados
    </h3>

    {% if blocks and blocks|length > 0 %}
      <div class="grid gap-3">
        {% for b in blocks %}
          <div class="rounded-xl border border-slate-700 bg-slate-900/40 px-4 py-3">
            <div class="flex items-center justify-between gap-4">

              <div>
                <div class="text-slate-100 font-semibold">
                    {% if b.start_date != b.end_date %}
                    {{ b.start_date.strftime("%d/%m/%Y") }} → {{ b.end_date.strftime("%d/%m/%Y") }}
                    {% else %}
                    {{ b.start_date.strftime("%d/%m/%Y") }}
                    {% endif %}
                </div>

                <div class="text-slate-300 text-sm">
                {{ b.reason }} —
                {% if b.applies_to_all %}   
                    Todos os profissionais
                {% else %}
                    {{ block_surgeons_map[b.id]|join(", ") }}
                {% endif %}
                </div>

              </div>

              <div class="flex items-center gap-2">
                <a
                  href="/bloqueios?edit={{ b.id }}"
                  class="rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm font-medium text-slate-100 hover:bg-white/10 transition"
                >
                  Editar
                </a>

                <form
                  method="post"
                  action="/bloqueios/{{ b.id }}/delete"
                  onsubmit="return confirm('Deseja realmente excluir este bloqueio?');"
                >
                  <button
                    type="submit"
                    class="rounded-xl border border-red-500/30 bg-red-500/10 px-3 py-2 text-sm font-semibold text-red-200 hover:bg-red-500/20 transition"
                  >
                    Excluir
                  </button>
                </form>
              </div>

            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-slate-400">
        Nenhum bloqueio cadastrado ainda.
      </p>
    {% endif %}
  </div>

</div>

<script>
  const di = document.querySelector('input[name="data_inicio"]');
  const df = document.querySelector('input[name="data_fim"]');
  if (di && df) {
    di.addEventListener("change", () => {
      if (!df.value) df.value = di.value;
    });
  }
</script>

{% endblock %}
