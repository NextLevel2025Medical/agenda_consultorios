{% extends "base.html" %}
{% block content %}

<div class="card max-w-5xl">

  <!-- Cabeçalho -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <h2 class="text-2xl font-semibold text-slate-100">Comissões — Cirurgias Agendadas</h2>
      <p class="text-slate-400">
        Período comercial (25 → 24), baseado na data do agendamento (<code>created_at</code>).
      </p>
    </div>

    <a
      href="/logout"
      class="rounded-xl border border-white/10 bg-white/5 px-4 py-2 text-sm font-medium text-slate-100 hover:bg-white/10 transition"
    >
      Sair
    </a>
  </div>

  <!-- Card filtro -->
  <div class="rounded-2xl border border-white/10 bg-white/5 p-5 mb-6">
    <form method="get" action="/comissoes" class="grid grid-cols-1 md:grid-cols-4 gap-3 items-end">
      <div class="md:col-span-1">
        <label class="block text-sm font-semibold text-slate-200 mb-1">Mês/Ano</label>
        <input
          class="input w-full"
          type="month"
          name="month_year"
          value="{{ month_year }}"
          required
        />
        <p class="text-xs text-slate-400 mt-1">Ex.: 2026-01</p>
      </div>

      <div class="md:col-span-2">
        <label class="block text-sm font-semibold text-slate-200 mb-1">Vendedor (opcional)</label>

        {# Se o backend enviar sellers (lista de usuários vendedores), usamos dropdown #}
        {% if sellers is defined and sellers %}
          <select class="input w-full" name="seller_id">
            <option value="">Todos</option>
            {% for s in sellers %}
              <option value="{{ s.id }}"
                {% if seller_id is defined and seller_id and (s.id|string) == (seller_id|string) %}selected{% endif %}
              >
                {{ s.full_name }}
              </option>
            {% endfor %}
          </select>
        {% else %}
          {# fallback: campo texto. backend pode usar seller_name (string) se preferir #}
          <input
            class="input w-full"
            type="text"
            name="seller"
            value="{{ seller or '' }}"
            placeholder="Digite o nome do vendedor (opcional)"
          />
        {% endif %}
      </div>

      <div class="md:col-span-1 flex gap-2 justify-end">
        <button class="btn-cta" type="submit">Buscar</button>

        {# CSV: você cria depois a rota /comissoes/csv e mantém este botão #}
        <a
          href="/comissoes/csv?month_year={{ month_year }}{% if seller is defined and seller %}&seller={{ seller|urlencode }}{% endif %}{% if seller_id is defined and seller_id %}&seller_id={{ seller_id }}{% endif %}"
          class="rounded-xl border border-white/10 bg-white/5 px-4 py-2 text-sm font-medium text-slate-100 hover:bg-white/10 transition"
        >
          Exportar CSV
        </a>
      </div>
    </form>
  </div>

  <!-- Resumo -->
  <div class="rounded-2xl border border-white/10 bg-white/5 p-5 mb-6">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div class="text-slate-200 font-semibold">
        Período: <span class="text-slate-100">{{ period_start.strftime("%d/%m/%Y") }}</span>
        →
        <span class="text-slate-100">{{ period_end.strftime("%d/%m/%Y") }}</span>
      </div>

      <div class="text-slate-200">
        Total de cirurgias no período: <span class="font-extrabold text-slate-100">{{ total }}</span>
      </div>
    </div>
    <p class="text-xs text-slate-400 mt-2">
      * Somente <b>Cirurgia</b> e não-reserva. Se um agendamento foi excluído, ele deixa de aparecer (estorno automático).
    </p>
  </div>

  <!-- Lista por vendedor -->
  <div class="space-y-3">

    {% if grouped and grouped|length > 0 %}
      {% for seller_label, items in grouped.items() %}

        {# tenta mostrar nome do vendedor via users_by_id se a chave for id; se não, usa label #}
        {% set seller_name = seller_label %}
        {% if users_by_id is defined %}
          {% if seller_label is number and users_by_id.get(seller_label) %}
            {% set seller_name = users_by_id.get(seller_label).full_name %}
          {% endif %}
        {% endif %}

        <details class="rounded-2xl border border-white/10 bg-white/5 p-4">
          <summary class="cursor-pointer select-none flex items-center justify-between gap-3">
            <div class="text-slate-100 font-extrabold">
              {{ seller_name }}
              <span class="text-slate-400 font-semibold">— {{ items|length }} cirurgia{{ "s" if items|length != 1 else "" }}</span>
            </div>
            <div class="text-slate-400 text-sm">Clique para expandir</div>
          </summary>

          <div class="mt-4 space-y-2">
            {% for e in items %}
              <div class="rounded-xl border border-white/10 bg-white/5 p-3">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                  <div class="text-slate-100 font-semibold">
                    {{ e.created_at.strftime("%d/%m/%Y %H:%M") }}
                  </div>
                  <div class="text-slate-400 text-sm">
                    {{ e.patient_name }}
                  </div>
                </div>

                <div class="mt-2 text-sm text-slate-300">
                  <span class="text-slate-400 font-semibold">Cirurgião:</span>
                  {% if users_by_id is defined and users_by_id.get(e.surgeon_id) %}
                    {{ users_by_id.get(e.surgeon_id).full_name }}
                  {% else %}
                    ID {{ e.surgeon_id }}
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        </details>

      {% endfor %}
    {% else %}
      <div class="rounded-2xl border border-white/10 bg-white/5 p-6 text-slate-300">
        Nenhuma cirurgia encontrada para o período selecionado.
      </div>
    {% endif %}

  </div>

</div>

{% endblock %}
