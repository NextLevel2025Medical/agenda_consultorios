{% extends "base.html" %}
{% block page_title %}CONCEPT SYS - HOSPEDAGENS CONCEPT{% endblock %}
{% block header_title %}CONCEPT SYS - HOSPEDAGENS CONCEPT{% endblock %}
{% block content %}

{% set parts = selected_month.split('-') %}
{% set sel_year = parts[0] %}
{% set sel_month = parts[1] %}

<style>
  .toolbar { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
  .month-controls { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .month-controls select.input { width: 120px;  min-width: 120px; }
  .btn-small { padding: 10px 14px; font-size: 14px; border-radius: 12px; }
  .legend { display:flex; gap:14px; align-items:center; flex-wrap:wrap; color: var(--muted); font-size: 13px; }
  .legend .swatch { display:inline-block; width:26px; height:10px; border-radius: 999px; background: rgba(255,255,255,0.18); }
  .legend .swatch.pre { background: transparent; border: 2px dashed rgba(255,255,255,0.35); }

  /* GRID */
  .lodging-wrap{
    margin-top: 14px;
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 18px;
    overflow: hidden;
    background: rgba(255,255,255,0.03);
  }

  .grid-head, .grid-row{
    display:grid;
    grid-template-columns: 170px 1fr;
    align-items: stretch;
  }

  .left-cell{
    padding: 14px 14px;
    border-right: 1px solid rgba(255,255,255,0.08);
    background: rgba(0,0,0,0.15);
    font-weight: 900;
    color: var(--text);
  }

  .scroll-x{
    overflow: visible;      
  }

  .days-head{
    display:grid;
    gap: 0;
    position: relative;
    background: rgba(0,0,0,0.10);
    grid-template-columns: repeat({{ days|length }}, minmax(0, 1fr));
    box-sizing: border-box;
  }

  .day-pill{
    height: 44px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight: 900;
    font-size: 12px;
    color: rgba(255,255,255,0.70);
    border-right: 1px solid rgba(255,255,255,0.05);
    box-sizing: border-box;
  }

  .row-grid{
    display:grid;
    position: relative;
    height: 54px;
    background: rgba(255,255,255,0.02);
    grid-template-columns: repeat({{ days|length }}, minmax(0, 1fr));
    box-sizing: border-box;

  }

  .day-cell{
    border-right: 1px solid rgba(255,255,255,0.05);
    border-top: 1px solid rgba(255,255,255,0.06);
    height: 54px;
    cursor: pointer;
    box-sizing: border-box;
  }
 
   .day-cell:hover{ background: rgba(255,255,255,0.05); }

  .bar{
    /* ✅ força a barra a ficar na mesma linha (sobrepondo as cells) */
    grid-row: 1;

    align-self: stretch;
    height: 100%%;
    border-radius: 10px;
    box-sizing: border-box;
    background: rgba(34,197,94,0.25);
    border: 1px solid rgba(34,197,94,0.45);
    padding: 6px 10px;
    display:flex;
    align-items:center;
    gap:10px;
    overflow:hidden;
    white-space:nowrap;
    text-overflow: ellipsis;
    z-index: 3;
    cursor: pointer;
    color: #ecfdf5;
  }
  .modal-actions button{
    flex: 1;
  }

  .modal-actions{
    display:flex;
    justify-content:flex-end;
    gap:10px;
    margin-top: 14px;
  }

  .bar.pre{
    background: rgba(253,224,71,0.30);     /* ✅ amarelo claro */
    border: 1px dashed rgba(253,224,71,0.70);
    color: #422006;
  }

  .btn-warning{
    background: linear-gradient(180deg,#facc15,#eab308);
    color:#422006;
    font-weight:900;
    border: none;
  }

  .btn-warning:hover{
    filter: brightness(1.05);
  }

  .bar .pname{
    font-weight: 900;
    font-size: 13px;
    color: var(--text);
    overflow:hidden;
    text-overflow: ellipsis;
  }

  /* MODAL igual ao padrão do mapa */
  .modal-backdrop{
    display:none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.65);
    align-items: center;
    justify-content: center;
    z-index: 50;
    padding: 18px;
  }
  .modal{
    width: min(720px, 96vw);
    background: rgba(15, 23, 42, 0.95);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 18px;
    padding: 18px;
    box-shadow: 0 30px 80px rgba(0,0,0,0.55);
  }
  .modal-head{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; }
  .modal-title{ font-size: 18px; font-weight: 900; }
  .modal-grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 14px; }
  .modal-grid .full{ grid-column: 1 / -1; }
  .modal-actions{ display:flex; justify-content:flex-end; gap:10px; margin-top: 14px; }
  .err-box{ margin-top:12px; padding:12px 14px; border-radius: 14px; background: rgba(239,68,68,0.12); border: 1px solid rgba(239,68,68,0.35); color: rgba(255,255,255,0.88); font-weight: 700; }

  @media (max-width: 780px){
    .grid-head, .grid-row{ grid-template-columns: 140px 1fr; }
    .modal-grid{ grid-template-columns: 1fr; }
  }
</style>

<div class="card">
  <div class="toolbar">
    <div class="month-controls">
      <form method="get" action="/hospedagem" class="month-controls">
        <select class="input" name="year" onchange="this.form.submit()">
            {% for y in years %}
            <option value="{{ y }}" {% if y == sel_year|int %}selected{% endif %}>
                {{ y }}
            </option>
            {% endfor %}
        </select>

        <select class="input" name="month" onchange="this.form.submit()">
            {% set month_names = {
            1:"Janeiro", 2:"Fevereiro", 3:"Março", 4:"Abril", 5:"Maio", 6:"Junho",
            7:"Julho", 8:"Agosto", 9:"Setembro", 10:"Outubro", 11:"Novembro", 12:"Dezembro"
            } %}
            {% for m in range(1,13) %}
            <option value="{{ '%04d-%02d'|format(sel_year|int, m) }}"
                {% if m == sel_month|int %}selected{% endif %}>
                {{ month_names[m] }}
            </option>
            {% endfor %}
        </select>
      </form>

      <button class="btn btn-small btn-warning" type="button" onclick="openCreateModal(null)">Nova Reserva</button>
    </div>
  </div>

  {% if err %}
    <div class="err-box">{{ err }}</div>
  {% endif %}

  {% if conflict and allow_override %}
  <div class="err-box" style="background: rgba(245,158,11,0.12); border-color: rgba(245,158,11,0.35);">
    <div style="font-weight:700; margin-bottom:6px;">Conflito encontrado</div>
    <div style="opacity:.95;">
      Já existe uma reserva para <b>{{ conflict.patient_name }}</b>
      ({{ conflict.check_in }} → {{ conflict.check_out }}) na acomodação <b>{{ conflict.unit }}</b>.
    </div>
    <div style="margin-top:10px; display:flex; gap:10px; justify-content:flex-end;">
      <a class="btn" href="/hospedagem?month={{ selected_month }}">Cancelar</a>

      <form method="post" action="/hospedagem/override" style="display:inline;">
        <input type="hidden" name="month" value="{{ selected_month }}">
        <input type="hidden" name="conflict_id" value="{{ conflict.id }}">

        <!-- payload novo (vem do prefill do modal) -->
        <input type="hidden" name="unit" value="{{ prefill.unit }}">
        <input type="hidden" name="patient_name" value="{{ prefill.patient_name }}">
        <input type="hidden" name="check_in" value="{{ prefill.check_in }}">
        <input type="hidden" name="check_out" value="{{ prefill.check_out }}">
        <input type="hidden" name="is_pre_reservation" value="{{ 1 if prefill.is_pre_reservation else '' }}">
        <input type="hidden" name="note" value="{{ prefill_note }}">
        {% if surgery_entry_id %}
            <input type="hidden" name="surgery_entry_id" value="{{ surgery_entry_id }}">
        {% endif %}
        <button class="btn btn-primary" type="submit">Sobrepor</button>
      </form>
    </div>
  </div>
{% endif %}

  <div class="legend" style="margin-top:10px;">
    <span><span class="swatch"></span> Confirmada</span>
    <span><span class="swatch pre"></span> Pré-reserva</span>
  </div>

  <div class="lodging-wrap">
    <!-- Cabeçalho -->
    <div class="grid-head">
      <div class="left-cell">Acomodação</div>
      <div class="scroll-x">
        <div class="days-head">
          {% for d in days %}
            <div class="day-pill">{{ '%02d'|format(d.day) }}</div>
          {% endfor %}
        </div>
      </div>
    </div>

    {% for u in units %}
    <div class="grid-row">
        <div class="left-cell">{{ human_unit(u) }}</div>
        <div class="scroll-x">
        <div class="row-grid" data-unit="{{ u }}">
            {% for d in days %}
            <div class="day-cell" onclick="openCreateModal('{{ u }}','{{ d.isoformat() }}')"></div>
            {% endfor %}

            {% for b in bars_by_unit.get(u, []) %}
            <div
                class="bar {% if b.is_pre %}pre{% endif %}"
                style="grid-column: {{ (b.start_col - 1) }} / {{ (b.end_col - 1) }};"
                onclick="openEditModal(this)"
                data-id="{{ b.id }}"
                data-unit="{{ u }}"
                data-patient="{{ b.patient_name }}"
                data-check-in="{{ b.check_in }}"
                data-check-out="{{ b.check_out }}"
                data-is-pre="{{ 1 if b.is_pre else 0 }}"
                data-note="{{ b.note|e }}"
                data-created-by="{{ b.created_by_id or '' }}"
            >
                <div class="pname">{{ b.patient_name }}</div>
            </div>
            {% endfor %}
        </div>
        </div>
    </div>
    {% endfor %}

  </div>
</div>

<!-- Reservas do mês (somente abaixo do quadro) -->
{% if reservations_list and reservations_list|length > 0 %}
  <div style="margin-top:22px;">
    <div style="font-weight:900; margin-bottom:10px;">Reservas do mês</div>

    <div style="display:flex; flex-direction:column; gap:10px;">
      {% for r in reservations_list %}
        <div style="display:flex; justify-content:space-between; gap:14px; padding:14px; border:1px solid rgba(255,255,255,0.08); border-radius:16px; background: rgba(255,255,255,0.03);">
          <div>
            <div style="font-weight:900;">
              {{ r.check_in_br }} → {{ r.check_out_br }}
              {% if r.is_pre %}<span class="pill pre" style="margin-left:8px;">Pré-reserva</span>{% endif %}
            </div>

            <div style="color: rgba(255,255,255,0.85); margin-top:4px;">
              {{ human_unit(r.unit) }} — {{ r.patient_name }}
              {% if r.note %}<span style="opacity:.75;"> — {{ r.note }}</span>{% endif %}
            </div>

            <div style="color: rgba(255,255,255,0.65); font-size: 13px; margin-top:6px;">
            Criado por <b>{{ r.created_by_username or "-" }}</b> em <b>{{ r.created_at_str or "-" }}</b>
            </div>
          </div>

          <div style="display:flex; gap:10px; align-items:center;">
            <button
              class="btn btn-small"
              type="button"
              onclick="openEditModal(this)"
              data-id="{{ r.id }}"
              data-unit="{{ r.unit }}"
              data-patient="{{ r.patient_name }}"
              data-check-in="{{ r.check_in_br }}"
              data-check-out="{{ r.check_out_br }}"
              data-is-pre="{{ 1 if r.is_pre else 0 }}"
              data-note="{{ r.note|e }}"
            >
              Editar
            </button>

            <form method="post" action="/hospedagem/delete/{{ r.id }}" style="margin:0;">
              <input type="hidden" name="month" value="{{ selected_month }}">
              <button class="btn btn-small btn-danger" type="submit" onclick="return confirm('Excluir esta reserva?')">
                Excluir
              </button>
            </form>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
{% endif %}


<!-- MODAL -->
<div class="modal-backdrop" id="lodgingBackdrop" onclick="maybeClose(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-head">
      <div>
        <div class="modal-title" id="lodgingTitle">Reserva de Hospedagem</div>
      </div>
      <button class="btn btn-small" type="button" onclick="closeModal()">Fechar</button>
    </div>

    <form id="lodgingForm" method="post" action="/hospedagem/create">
      <input type="hidden" name="month" value="{{ selected_month }}">
      <div class="modal-grid">
        <div>
          <label class="muted">Acomodação</label>
          <select class="input" name="unit" id="unitEl">
            <option value="suite_1">Suíte 1</option>
            <option value="suite_2">Suíte 2</option>
            <option value="apto">Apartamento</option>
          </select>
        </div>

        <div style="display:flex; align-items:flex-end; gap:10px;">
          <label style="display:flex; gap:10px; align-items:center; padding-bottom: 4px;">
            <input type="checkbox" name="is_pre_reservation" id="preEl">
            <span class="muted">Pré-reserva</span>
          </label>
        </div>

        <div>
          <label class="muted">Check-in</label>
          <input class="input" type="date" name="check_in" id="checkInEl" required>
        </div>

        <div>
          <label class="muted">Check-out</label>
          <input class="input" type="date" name="check_out" id="checkOutEl" required>
        </div>

        <div class="full">
          <label class="muted">Paciente</label>
          <input class="input" type="text" name="patient_name" id="patientEl" required placeholder="NOME DO PACIENTE">
        </div>

        <div class="full">
          <label class="muted">Observação (opcional)</label>
          <textarea class="input" name="note" id="noteEl" rows="2" placeholder="Ex: entrada antes da cirurgia, acompanhante, etc."></textarea>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn" type="button" id="deleteBtn" onclick="submitDelete()" style="display:none;">Excluir</button>
        <button class="btn btn-primary" type="submit" id="saveBtn">Salvar Reserva</button>
      </div>
    </form>

    <form id="deleteForm" method="post" style="display:none;">
      <input type="hidden" name="month" value="{{ selected_month }}">
    </form>
  </div>
</div>

<script>
  const backdrop = document.getElementById("lodgingBackdrop");
  const formEl = document.getElementById("lodgingForm");

  const titleEl = document.getElementById("lodgingTitle");
  const unitEl = document.getElementById("unitEl");
  const preEl = document.getElementById("preEl");
  const checkInEl = document.getElementById("checkInEl");
  const checkOutEl = document.getElementById("checkOutEl");
  const patientEl = document.getElementById("patientEl");
  const noteEl = document.getElementById("noteEl");

  const deleteBtn = document.getElementById("deleteBtn");
  const deleteForm = document.getElementById("deleteForm");

  function toDateInput(iso){ return iso; }

  function addDays(iso, n){
    const d = new Date(iso + "T00:00:00");
    d.setDate(d.getDate() + n);
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }

  function openCreateModal(unit, dayIso){
    formEl.action = "/hospedagem/create";
    titleEl.textContent = "Reserva de Hospedagem";
    deleteBtn.style.display = "none";

    // reset
    formEl.reset();

    if (unit) unitEl.value = unit;

    if (dayIso){
      checkInEl.value = toDateInput(dayIso);
      checkOutEl.value = addDays(dayIso, 1);
    }

    backdrop.style.display = "flex";
    patientEl.focus();
  }

  function openEditModal(el){
    const d = el.dataset;
    formEl.action = "/hospedagem/update/" + d.id;
    titleEl.textContent = "Editar Reserva";
    deleteBtn.style.display = "inline-flex";

    // preencher
    unitEl.value = d.unit;
    patientEl.value = d.patient || "";
    preEl.checked = (d.isPre === "1");
    noteEl.value = d.note || "";

    // datas vêm em dd/mm/yyyy -> converter
    const ci = d.checkIn.split("/");
    const co = d.checkOut.split("/");
    checkInEl.value = `${ci[2]}-${ci[1]}-${ci[0]}`;
    checkOutEl.value = `${co[2]}-${co[1]}-${co[0]}`;

    // form delete
    deleteForm.action = "/hospedagem/delete/" + d.id;

    backdrop.style.display = "flex";
  }

  function closeModal(){
    backdrop.style.display = "none";
  }

  function maybeClose(e){
    if (e.target === backdrop) closeModal();
  }

  function submitDelete(){
    if (!confirm("Excluir esta reserva de hospedagem?")) return;
    deleteForm.submit();
  }

  function submitDeleteFromList(id){
    if (!confirm("Excluir esta reserva de hospedagem?")) return;
    deleteForm.action = "/hospedagem/delete/" + id;
    deleteForm.submit();
    }

  // Prefill via query params (open=1)
  (function(){
    const openFlag = "{{ prefill and prefill.get('unit') is not none and open }}" ;
  })();

  {% if open and open == "1" %}
    (function(){
      const u = "{{ (prefill.unit if prefill is defined else '') }}";
      const ci = "{{ (prefill.check_in if prefill is defined else '') }}";
      const co = "{{ (prefill.check_out if prefill is defined else '') }}";
      const p = "{{ (prefill.patient_name if prefill is defined else '') }}";
      const isPre = "{{ (prefill.is_pre_reservation if prefill is defined else 0) }}";
      const editId = "{{ (prefill.edit_id if prefill is defined else '') }}";

      if (editId){
        // se veio para editar, apenas abrir modal vazio; edição normalmente vem por clique
        openCreateModal(u || null, null);
      } else {
        openCreateModal(u || null, ci || null);
        if (co) checkOutEl.value = co;
        if (p) patientEl.value = p;
        if (isPre === "1") preEl.checked = true;
      }
    })();
  {% endif %}
</script>

{% endblock %}
