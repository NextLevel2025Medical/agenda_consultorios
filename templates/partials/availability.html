{# templates/partials/availability.html #}

<div class="rounded-2xl bg-white/5 border border-white/10 p-4">
  <div class="flex items-center justify-between gap-3 mb-4">
    <div class="text-sm text-slate-300">
      Disponibilidade — <span class="text-slate-200 font-medium">{{ date_human }}</span>
    </div>
    <div class="text-xs text-slate-500">
      Intervalos de 30 min (07:00–19:00)
    </div>
  </div>

  <div class="overflow-x-auto">
    <div class="min-w-[860px]">
      <div
        class="grid gap-px bg-white/10 rounded-2xl overflow-hidden"
        style="grid-template-columns: 120px repeat({{ rooms|length }}, minmax(240px, 1fr));"
      >
        {# HEADER #}
        <div class="sticky left-0 z-20 bg-slate-950/80 backdrop-blur px-4 py-3 text-xs font-semibold text-slate-200 border-r border-white/10">
          Horário
        </div>

        {% for room in rooms %}
          <div class="z-10 bg-slate-950/60 backdrop-blur px-4 py-3 border-r border-white/10">
            <div class="text-sm font-semibold text-slate-100">{{ room.name }}</div>
            {% if room.description %}
              <div class="text-xs text-slate-400 mt-1">{{ room.description }}</div>
            {% endif %}
          </div>
        {% endfor %}

        {# ROWS (SLOTS) #}
        {% for slot in slots %}
          {% set key = slot.isoformat() %}

          {# TIME CELL #}
          <div class="sticky left-0 z-10 bg-slate-950/80 backdrop-blur px-4 py-4 text-sm font-semibold text-slate-100 border-r border-white/10">
            {{ slot.strftime("%H:%M") }}
          </div>

          {# CELLS FOR EACH ROOM #}
          {% for room in rooms %}
            {% set occ = occupancy.get(room.id, {}).get(key) %}

            <div class="bg-slate-950/40 px-4 py-4 border-r border-white/10">
              <div class="flex items-start justify-between gap-3">
                <div class="min-w-0">
                  {% if occ and occ.type == "reservation" %}
                    <div class="text-xs text-slate-300">
                      Reservado
                      <span class="text-slate-50 font-semibold">· {{ occ.doctor_name }}</span>
                    </div>
                  {% elif occ and occ.type == "request" %}
                    <div class="text-xs text-amber-200/90">
                      Solicitação pendente
                      <span class="text-amber-50 font-semibold">· {{ occ.doctor_name }}</span>
                    </div>
                  {% else %}
                    <div class="text-xs text-emerald-200/90">Livre</div>
                  {% endif %}
                </div>

                <div class="shrink-0">
                  {% if not occ %}
                    {% if role == "doctor" %}
                      <form method="post" action="/doctor/request" class="m-0">
                        <input type="hidden" name="room_id" value="{{ room.id }}" />
                        <input type="hidden" name="start_iso" value="{{ key }}" />
                        <button class="rounded-xl bg-white/10 px-3 py-2 text-xs hover:bg-white/15 transition">
                          Solicitar
                        </button>
                      </form>
                    {% else %}
                      <form method="post" action="/admin/reserve" class="m-0">
                        <input type="hidden" name="room_id" value="{{ room.id }}" />
                        <input type="hidden" name="start_iso" value="{{ key }}" />

                        <div class="flex items-center gap-2">
                          <select name="doctor_id" class="rounded-xl bg-slate-900/60 border border-white/10 px-2 py-2 text-xs">
                            {% for d in doctors %}
                              <option value="{{ d.id }}">{{ d.full_name }}</option>
                            {% endfor %}
                          </select>

                          <button class="rounded-xl bg-emerald-500/90 px-3 py-2 text-xs font-medium text-slate-950 hover:bg-emerald-500 transition">
                            Reservar
                          </button>
                        </div>
                      </form>
                    {% endif %}
                  {% else %}
                    <div class="text-xs text-slate-600">—</div>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        {% endfor %}
      </div>
    </div>
  </div>
</div>
